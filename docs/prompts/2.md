Prompt 2: The Broker & Integration Layer

    Task: Implement the BrokerService & Companion HTML PoC (Prompt 2)

    1. The BrokerService Implementation:

        Create a module that takes the Visual Manifest and Style Guide (from Prompt 1) and "compiles" them into the final JSON payload for the Visualization Engine.

        Mapping Logic:

            ID Management: Assign a unique visualizationId (e.g., lesson-1-viz-1) to each artifact.

            Type Mapping: Ensure the template_type in the manifest correctly maps to the Visualization App's supported types (e.g., bento_grid, versus_split, story_image).

            Data Sanitization: Format the data_payload to match the exact schema of the target template (e.g., ensuring keys like items or imageSpecs are correctly nested).

    2. Global Style Injection:

        The BrokerService must inject the document's Style Guide into every payload.

        Ensure the globalStyleGuide object is appended to each request, mapping the document's palette to the template's expected variables.

    3. API Handshake (Integration):

        Implement an asynchronous HTTP client to POST the compiled payloads to the Visualization Engineâ€™s endpoint.

        Resilience: Implement a sequential queue for this phase to ensure each artifact is successfully acknowledged before the next is sent.

    4. The "Companion HTML" Generator (Validation PoC):

        Create a script that generates a local review.html file.

        Layout:

            Left Column: The full Markdown text of the document.

            Right Column: The generated PNGs (or placeholders) aligned horizontally with their respective anchor_sentence.

        This serves as the "Surgical Insertion" simulator to verify placement logic before we modify the .docx file.

    5. Success Criteria:

        A console log showing a successful JSON handshake with the Visualization Engine for at least 3 artifacts.

        Generation of a review.html file that correctly displays text alongside its pedagogical visual anchors.

        Execution time for the "Broker" and "HTML Generation" phases should be under 10 seconds.